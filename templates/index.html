<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Copier Plus</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <style>
        body{
            grid-template-columns: none !important;
        }
        
        .title{
            margin: 0;
        }

        .last_message{
            margin: 0;
            font-size: 16px;
            color: gray;
        }

        .chat-container{
            border-bottom: 1px solid gray;
            transition: 0.2s;
        }

        .chat-container:hover{
            background: #3a3a3a;
        }

        .source-destination-chat-container{
            display: flex;
            max-height: 100vh;
        }

        .disabled {
            background: #3a3a3a;
            border: none;
        }

        .disabled:hover{
            background: #3a3a3a !important;
            cursor: not-allowed !important;
        }

        .invisible{
            display: none;
        }


    </style>

</head>
<body>

    <div class="source-destination-chat-container">
        <div id="topic_container" class="invisible">
            <h3>Topic</h3>
            <div id="topic_source_list" style="overflow: scroll; max-height: calc(100% - 150px)"></div>
        </div>
        <div style="width: 40px"></div>
        <div>
            <h3>Source chat</h3>
            <div id="dialogs_source_list" style="overflow: scroll; max-height: calc(100% - 150px)"></div>
        </div>
        <div style="width: 40px"></div>
        <div>
            <h3>Destination chat</h3>
            <div id="dialogs_destination_list" style="overflow: scroll; max-height: calc(100% - 150px)"></div>
        </div>
            <div style="width: 40px"></div>
        <div>
            <h3>Rules</h3>
            <button id="new_rule_button" onclick="addRule()" class="disabled">Add rule</button>
            <div id="rule_list"></div>
        </div>
    </div>



</body>

<script>

    let dom_source_list = document.getElementById("dialogs_source_list");
    let dom_destination_list = document.getElementById("dialogs_destination_list");

    let source_selection = "";
    let destination_selection = "";
    let source_topic = "";

    let dialog_list = [];

    fetch('/api/v0/dialog_list')
        .then((response) => response.json())
        .then((data) => {
            console.log(data);
            dialog_list = data;
            data.forEach((item, index)=>{
                dom_source_list.innerHTML+= `
                    <div class="chat-container" onclick=sourceClicked(${item.id}) id=s${item.id}>
                        <p class="title">${item.name}</p>
                        <p class="last_message">${item.last_message === "" ? "Media" : item.last_message}</p>
                    </div>`

                dom_destination_list.innerHTML+= `
                    <div class="chat-container" onclick=destinationClicked(${item.id}) id=d${item.id}>
                        <p class="title">${item.name}</p>
                        <p class="last_message">${item.last_message === "" ? "Media" : item.last_message}</p>
                    </div>`


            });

            getRules();

        });

    function sourceClicked(id){
        clearTopic();
        let chat = document.getElementById("s" + id);

        if (source_selection === id) {
            // elemento selezionato, lo deseleziono (toggle)
            source_selection = "";
            chat.style.background="transparent";
        } else if (source_selection === "") {
            // primo elemento ad essere selezinato
            source_selection = id;
            chat.style.background="rgba(0,68,244,0.5)"
        } else {
            // ho selezionato un elemento vecchio e lo deseleziono, mentre seleziono quello nuovo
            let old_chat = document.getElementById("s" + source_selection);
            old_chat.style.background="transparent";
            source_selection = id;
            chat.style.background="rgba(0,68,244,0.5)"
        }

        checkRule();
        checkTopic();
    }

    function clearTopic(){
        document.getElementById("topic_source_list").innerHTML = ""
        document.getElementById("topic_container").classList.add("invisible");
        source_topic = "";
    }

    function destinationClicked(id){
        let chat = document.getElementById("d" + id);

        if (destination_selection === id) {
            // elemento selezionato, lo deseleziono (toggle)
            destination_selection = "";
            chat.style.background="transparent";
        } else if (destination_selection === "") {
            // primo elemento ad essere selezinato
            destination_selection = id;
            chat.style.background="rgba(0,68,244,0.5)"
        } else {
            // ho selezionato un elemento vecchio e lo deseleziono, mentre seleziono quello nuovo
            let old_chat = document.getElementById("d" + destination_selection);
            old_chat.style.background="transparent";
            destination_selection = id;
            chat.style.background="rgba(0,68,244,0.5)"
        }

        checkRule();
    }

    function checkRule(){
        let new_rule_button = document.getElementById("new_rule_button")

        if (source_selection !== "" && destination_selection !== ""){
            // possible new rule
            new_rule_button.classList.remove("disabled")
        } else {
            new_rule_button.classList.add("disabled")
        }
    }

    function checkTopic(){
        if (source_selection === ""){
            return
        }

        fetch(`/api/v0/get_topic/${source_selection}`)
        .then((response) => response.json())
        .then((data) => {
            console.log(data)
            if (data.has_topics){
                // ha topic, mostriamoli
                console.log(data.topics)
                document.getElementById("topic_container").classList.remove("invisible");
                let topic_list = document.getElementById("topic_source_list");
                data.topics.forEach((item, key)=>{
                    topic_list.innerHTML+=`<p style="cursor: pointer" onclick=topicClicked(${item.id}) id=${item.id}>${item.title} (${item.id})</p>`
                })
            }


        });
    }

    function topicClicked(id){
        document.getElementById(id).style.background = "rgba(0,68,244,0.5)"

        if (source_topic !== ""){
            document.getElementById(source_topic).style.background = "transparent"
        }
        source_topic = id
    }

    function addRule(){
        if (source_selection !== "" && destination_selection !== ""){

            if (source_topic === ""){
                fetch('api/v0/start_forward', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_id: source_selection,
                        destination_id: destination_selection
                    }),
                })
                .then(response => response.json())
                .then(data => {console.log(data); getRules();})
                .catch((error) => console.error('Error:', error));
            } else {
                fetch('api/v0/start_topic_forward', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_id: source_selection,
                        destination_id: destination_selection,
                        topic_id: source_topic
                    }),
                })
                .then(response => response.json())
                .then(data => {console.log(data); getRules();})
                .catch((error) => console.error('Error:', error));
            }

        }

    }
    
    function getRules(){

        fetch(`/api/v0/list_rules`)
        .then((response) => response.json())
        .then((data) => {
            let ruleList = document.getElementById("rule_list");
            ruleList.innerHTML = "";
            data.forEach((item)=>{
                let destination_name = "";
                let source_name = "";
                console.log(item);
                console.log(item.destination_id)
                dialog_list.forEach((dialog) =>{
                    if (dialog.id === item.destination_id){
                        console.log(dialog.name)
                        destination_name = dialog.name;
                    }
                    if (dialog.id === item.source_id){
                        source_name = dialog.name;
                    }
                });


                if (item.hasOwnProperty("topic_id")){
                    ruleList.innerHTML += `<p>${source_name} (${item.topic_id}) -> ${destination_name}<button onclick="removeRule(${item.source_id}, ${item.destination_id}, ${item.topic_id})">Delete</button></p>`

                } else {
                    ruleList.innerHTML += `<p>${source_name} -> ${destination_name}<button onclick="removeRule(${item.source_id}, ${item.destination_id})">Delete</button></p>`
                }
            })

        });
    }

    function removeRule(source_id, destination_id, topic_id=""){
        fetch('api/v0/stop_forward', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                source_id: source_id,
                destination_id: destination_id,
                topic_id: topic_id
            }),
        })
        .then(response => response.json())
        .then(data => {console.log(data); getRules();})
        .catch((error) => console.error('Error:', error));


    }

</script>
</html>